###########################################
# Apache Iceberg Training Setup
# Dremio + Nessie + MinIO
###########################################

services:
  # Init container to fix Nessie volume permissions
  nessie-init:
    image: alpine:latest
    container_name: nessie-init
    command: sh -c "adduser -D -u 185 default && chown -R default:root /data && chmod -R 775 /data"
    volumes:
      - nessie-data:/data
    restart: "no"
    labels:
      - "com.iceberg-training.service=init"
      - "com.iceberg-training.description=Initialize Nessie volume permissions"

  # Nessie Catalog Server Using RocksDB (Persistent Storage)
  nessie:
    image: projectnessie/nessie:latest
    container_name: nessie
    depends_on:
      nessie-init:
        condition: service_completed_successfully
    environment:
      - QUARKUS_OIDC_ENABLED=false
      - NESSIE_SERVER_AUTHENTICATION_ENABLED=false
      - NESSIE_VERSION_STORE_TYPE=ROCKSDB
    volumes:
      - nessie-data:/tmp/nessie-rocksdb-store
    networks:
      iceberg:
    ports:
      - "${NESSIE_PORT:-19120}:19120"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:19120/api/v2/config"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "com.iceberg-training.service=catalog"
      - "com.iceberg-training.description=Nessie Catalog Server"
  # MinIO Storage Server
  minio:
    image: minio/minio:latest
    container_name: minio
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-admin}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:-password}
      - MINIO_DOMAIN=storage
      - MINIO_REGION_NAME=${MINIO_REGION:-us-east-1}
      - MINIO_REGION=${MINIO_REGION:-us-east-1}
    networks:
      iceberg:
    ports:
      - "${MINIO_CONSOLE_PORT:-9001}:9001"
      - "${MINIO_API_PORT:-9000}:9000"
    volumes:
      - minio-data:/data
    command: ["server", "/data", "--console-address", ":9001"]
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    labels:
      - "com.iceberg-training.service=storage"
      - "com.iceberg-training.description=MinIO S3-compatible Object Storage"
  # Dremio Query Engine
  dremio:
    platform: linux/x86_64
    image: dremio/dremio-oss:latest
    container_name: dremio
    ports:
      - "${DREMIO_UI_PORT:-9047}:9047"
      - "${DREMIO_CLIENT_PORT:-31010}:31010"
      - "${DREMIO_FLIGHT_PORT:-32010}:32010"
    environment:
      - DREMIO_JAVA_SERVER_EXTRA_OPTS=-Dpaths.dist=file:///opt/dremio/data/dist
    volumes:
      - dremio-data:/opt/dremio/data
    networks:
      iceberg:
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9047"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    labels:
      - "com.iceberg-training.service=query-engine"
      - "com.iceberg-training.description=Dremio SQL Query Engine"

  # Dremio Init Container - Create Admin User
  dremio-init:
    image: curlimages/curl:latest
    container_name: dremio-init
    depends_on:
      dremio:
        condition: service_healthy
    command: >
      sh -c '
        echo "Waiting for Dremio to be ready...";
        for i in $$(seq 1 30); do
          if curl -f http://dremio:9047 >/dev/null 2>&1; then
            echo "Dremio is ready!";
            break;
          fi;
          echo "Waiting... ($$i/30)";
          sleep 2;
        done;

        echo "Creating admin user...";
        response=$$(curl -s -w "\n%{http_code}" -X PUT "http://dremio:9047/apiv2/bootstrap/firstuser" \
          -H "Content-Type: application/json" \
          -H "Authorization: null" \
          --data-raw "{\"userName\":\"admin\",\"firstName\":\"Admin\",\"lastName\":\"User\",\"email\":\"admin@example.com\",\"createdAt\":$$(date +%s)000,\"password\":\"${DREMIO_ADMIN_PASSWORD:-admin123}\"}");

        http_code=$$(echo "$$response" | tail -n1);
        body=$$(echo "$$response" | head -n-1);

        if [ "$$http_code" = "200" ]; then
          echo "✅ Admin user created successfully!";
          echo "   Username: admin";
          echo "   Password: ${DREMIO_ADMIN_PASSWORD:-admin123}";
        elif echo "$$body" | grep -q "User already exists"; then
          echo "ℹ️  Admin user already exists";
        else
          echo "⚠️  Unexpected response (HTTP $$http_code): $$body";
        fi;
      '
    restart: "no"
    networks:
      - iceberg
    labels:
      - "com.iceberg-training.service=init"
      - "com.iceberg-training.description=Initialize Dremio admin user"
networks:
  iceberg:
    name: ${NETWORK_NAME:-iceberg-training}_iceberg
    driver: bridge
    labels:
      - "com.iceberg-training.network=main"

volumes:
  nessie-data:
    name: ${NETWORK_NAME:-iceberg-training}_nessie-data
    labels:
      - "com.iceberg-training.volume=nessie"
      - "com.iceberg-training.description=Nessie RocksDB catalog data"
  minio-data:
    name: ${NETWORK_NAME:-iceberg-training}_minio-data
    labels:
      - "com.iceberg-training.volume=minio"
      - "com.iceberg-training.description=MinIO S3 object storage"
  dremio-data:
    name: ${NETWORK_NAME:-iceberg-training}_dremio-data
    labels:
      - "com.iceberg-training.volume=dremio"
      - "com.iceberg-training.description=Dremio metadata and configuration"
